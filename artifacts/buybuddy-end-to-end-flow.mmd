sequenceDiagram
    autonumber
    participant U as Customer (UI)
    participant A as Streamlit App (app.py)
    participant B as BuyBuddy Customer Agent
    participant O as Orchestrator Agent
    participant P as FridgeBuddy
    participant I as InsuranceBuddy

    U->>A: Send message
    A->>A: Append user message to session history

    A->>B: collect_customer_input_packet(user_input, history)
    B->>B: Generate customer draft + state metadata
    B-->>A: customer_intake_packet (JSON)

    A->>O: orchestrate_customer_packet(packet)
    O->>O: Validate state + routing_hint + iteration limits
    O->>O: Run inventory-first check and build structured inventory_check

    alt Explicit specialist ask OR internal no-match
        O->>P: specialist_request (JSON)
        P-->>O: product response (JSON)
        O->>O: Normalize and preserve specialist response detail
    else Product agreement reached
        O->>I: specialist_request (JSON)
        I-->>O: insurance response (JSON)
        O->>O: Normalize and preserve specialist response detail
    else Route = none
        O->>O: Keep response in BuyBuddy-only path with internal options
    end

    O->>O: Build orchestrator_result (JSON)
    Note over O: customer_response is concise and details stay in inventory and specialist blocks
    O-->>A: orchestrator_result

    A->>A: Store state/phase counters in session
    A->>A: Render inventory and specialist messages inline
    A-->>U: Show BuyBuddy response + structured inventory/specialist output

    opt Final phase
        U->>A: Generate proposal
        A->>B: Build consolidated quotation
        B-->>A: Quotation text
        A-->>U: Downloadable PDF proposal
    end
